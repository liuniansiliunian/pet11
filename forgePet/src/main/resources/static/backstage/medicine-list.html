<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>药品管理</title>
    <link rel="stylesheet" href="../assets/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>药品管理</h2>
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">添加药品</button>
        </div>
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="按药品名称搜索...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">搜索</button>
            </div>
        </div>
    </div>

    <table class="table table-striped table-hover">
        <thead>
        <tr>
            <th>ID</th>
            <th>药品名称</th>
            <th>价格</th>
            <th>库存</th>
            <th>生产厂家</th>
            <th>过期日期</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="medicineTableBody">
        </tbody>
    </table>
</div>

<div class="modal fade" id="addMedicineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加药品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMedicineForm">
                    <div class="mb-3">
                        <label for="medicineName" class="form-label">药品名称</label>
                        <input type="text" class="form-control" id="medicineName" required>
                    </div>
                    <div class="mb-3">
                        <label for="medicinePrice" class="form-label">价格</label>
                        <input type="number" class="form-control" id="medicinePrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="medicineStock" class="form-label">库存</label>
                        <input type="number" class="form-control" id="medicineStock" required>
                    </div>
                    <div class="mb-3">
                        <label for="medicineManufacturer" class="form-label">生产厂家</label>
                        <input type="text" class="form-control" id="medicineManufacturer">
                    </div>
                    <div class="mb-3">
                        <label for="medicineExpireDate" class="form-label">过期日期</label>
                        <input type="date" class="form-control" id="medicineExpireDate">
                    </div>
                    <div class="mb-3">
                        <label for="medicineDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="medicineDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveMedicineBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editMedicineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑药品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMedicineForm">
                    <input type="hidden" id="editMedicineId">
                    <div class="mb-3">
                        <label for="editMedicineName" class="form-label">药品名称</label>
                        <input type="text" class="form-control" id="editMedicineName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMedicinePrice" class="form-label">价格</label>
                        <input type="number" class="form-control" id="editMedicinePrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMedicineStock" class="form-label">库存</label>
                        <input type="number" class="form-control" id="editMedicineStock" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMedicineManufacturer" class="form-label">生产厂家</label>
                        <input type="text" class="form-control" id="editMedicineManufacturer">
                    </div>
                    <div class="mb-3">
                        <label for="editMedicineExpireDate" class="form-label">过期日期</label>
                        <input type="date" class="form-control" id="editMedicineExpireDate">
                    </div>
                    <div class="mb-3">
                        <label for="editMedicineDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="editMedicineDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateMedicineBtn">更新</button>
            </div>
        </div>
    </div>
</div>

<script src="../assets/bootstrap.bundle.min.js"></script>
<script src="../js/request.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadMedicineList();

        document.getElementById('saveMedicineBtn').addEventListener('click', saveMedicine);
        document.getElementById('updateMedicineBtn').addEventListener('click', updateMedicine);
        document.getElementById('searchBtn').addEventListener('click', () => searchMedicine(document.getElementById('searchInput').value));
        document.getElementById('searchInput').addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchMedicine(event.target.value);
            } else if (event.target.value.trim() === '') {
                loadMedicineList();
            }
        });
    });

    // 修正: 从 response.data 获取数据
    function loadMedicineList() {
        request.get('/medicine/list')
            .then(response => {
                if (response.code === 1 && response.data) {
                    renderMedicineTable(response.data);
                } else {
                    alert('获取药品列表失败: ' + (response.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取药品列表出错，请检查网络或后台服务');
            });
    }

    // 修正: 直接接收药品数组
    function renderMedicineTable(medicineList) {
        const tbody = document.getElementById('medicineTableBody');
        tbody.innerHTML = '';
        if (medicineList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无数据</td></tr>';
            return;
        }
        medicineList.forEach(medicine => {
            const expireDateStr = medicine.expireDate ? new Date(medicine.expireDate).toLocaleDateString() : '未设置';
            const row = `
                <tr>
                    <td>${medicine.id}</td>
                    <td>${medicine.name}</td>
                    <td>¥${medicine.price.toFixed(2)}</td>
                    <td>${medicine.stock}</td>
                    <td>${medicine.manufacturer || ''}</td>
                    <td>${expireDateStr}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editMedicine(${medicine.id})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMedicine(${medicine.id})">删除</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 修正: 不再发送 createTime
    function saveMedicine() {
        const medicine = {
            name: document.getElementById('medicineName').value,
            price: parseFloat(document.getElementById('medicinePrice').value),
            stock: parseInt(document.getElementById('medicineStock').value),
            manufacturer: document.getElementById('medicineManufacturer').value,
            expireDate: document.getElementById('medicineExpireDate').value || null,
            description: document.getElementById('medicineDescription').value
        };

        if (!medicine.name || isNaN(medicine.price) || isNaN(medicine.stock)) {
            alert('药品名称、价格和库存为必填项！');
            return;
        }

        request.post('/medicine/add', medicine)
            .then(response => {
                if (response.code === 1) {
                    alert('药品添加成功');
                    document.getElementById('addMedicineForm').reset();
                    const modalEl = document.getElementById('addMedicineModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    loadMedicineList();
                } else {
                    alert('药品添加失败: ' + response.msg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('药品添加出错');
            });
    }

    // 修正: 从 response.data 获取数据
    function searchMedicine(keyword) {
        const trimmedKeyword = keyword.trim();
        if (trimmedKeyword === '') {
            loadMedicineList();
            return;
        }
        request.get(`/medicine/search?keyword=${trimmedKeyword}`)
            .then(response => {
                if (response.code === 1 && response.data) {
                    renderMedicineTable(response.data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('搜索药品出错');
            });
    }

    // 修正: 使用/medicine/{id}接口提高效率
    function editMedicine(id) {
        request.get(`/medicine/${id}`)
            .then(response => {
                if (response.code === 1 && response.data) {
                    const medicine = response.data;
                    document.getElementById('editMedicineId').value = medicine.id;
                    document.getElementById('editMedicineName').value = medicine.name;
                    document.getElementById('editMedicinePrice').value = medicine.price;
                    document.getElementById('editMedicineStock').value = medicine.stock;
                    document.getElementById('editMedicineManufacturer').value = medicine.manufacturer || '';
                    const expireDateForInput = medicine.expireDate ? new Date(medicine.expireDate).toISOString().split('T')[0] : '';
                    document.getElementById('editMedicineExpireDate').value = expireDateForInput;
                    document.getElementById('editMedicineDescription').value = medicine.description || '';
                    const editModal = new bootstrap.Modal(document.getElementById('editMedicineModal'));
                    editModal.show();
                } else {
                    alert('获取药品信息失败: ' + response.msg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取药品信息出错');
            });
    }

    function updateMedicine() {
        const medicine = {
            id: parseInt(document.getElementById('editMedicineId').value),
            name: document.getElementById('editMedicineName').value,
            price: parseFloat(document.getElementById('editMedicinePrice').value),
            stock: parseInt(document.getElementById('editMedicineStock').value),
            manufacturer: document.getElementById('editMedicineManufacturer').value,
            expireDate: document.getElementById('editMedicineExpireDate').value || null,
            description: document.getElementById('editMedicineDescription').value
        };

        request.put('/medicine/update', medicine)
            .then(response => {
                if (response.code === 1) {
                    alert('药品更新成功');
                    const modalEl = document.getElementById('editMedicineModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                    loadMedicineList();
                } else {
                    alert('药品更新失败: ' + response.msg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('药品更新出错');
            });
    }

    function deleteMedicine(id) {
        if (confirm('确定要删除这个药品吗？')) {
            request.delete(`/medicine/delete/${id}`)
                .then(response => {
                    if (response.code === 1) {
                        alert('药品删除成功');
                        loadMedicineList();
                    } else {
                        alert('药品删除失败: ' + response.msg);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('药品删除出错');
                });
        }
    }
</script>
</body>
</html>